<!DOCTYPE html>
<html>
<head>
    <title>AR RPG: Mage, Warrior, Archer</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }
        .arjs-loader {
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; 
            background-color: rgba(0, 0, 0, 0.9); 
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 1.5em; z-index: 9999;
        }
    </style>
</head>
<body>
<div class="arjs-loader">Loading AR Scene...</div>

<script>
    window.playerChar = null;
    // Function to check for win/loss conditions
    function checkCombat(player, opponent) {
        console.log(`Combat: ${player} vs ${opponent}`);

        if (player === opponent) {
            return `TIE! You are both ${player}s.`;
        }

        // Win conditions: Mage > Warrior, Warrior > Archer, Archer > Mage
        if (
            (player === 'mage' && opponent === 'warrior') ||
            (player === 'warrior' && opponent === 'archer') ||
            (player === 'archer' && opponent === 'mage')
        ) {
            return `VICTORY! ${player} defeats ${opponent}!`;
        } else {
            return `DEFEAT! ${opponent} overpowers ${player}.`;
        }
    }

    // A-Frame Component for Marker Interaction
    AFRAME.registerComponent('rpg-marker-listener', {
        schema: {
            char: { type: 'string' } // 'mage', 'warrior', or 'archer'
        },

        init: function () {
            const el = this.el;
            const charName = this.data.char;
            const resultText = document.getElementById('result-text');
            const modelEntity = document.getElementById(`${charName}-model`);

            // --- Marker Found Event ---
            el.addEventListener('markerFound', () => {
                if (window.playerChar === null) {
                    // 1. Selection Phase
                    window.playerChar = charName;
                    resultText.setAttribute('value', `SELECTED: ${charName.toUpperCase()}! Now scan an opponent.`);
                    resultText.setAttribute('color', 'yellow');
                    
                    // Show the selected character's model
                    modelEntity.setAttribute('visible', true);

                    console.log(`Player selected: ${charName}`);
                } else if (window.playerChar !== charName) {
                    // 2. Combat Phase
                    const result = checkCombat(window.playerChar, charName);
                    resultText.setAttribute('value', `${result}\nScan a marker to restart.`);
                    resultText.setAttribute('color', result.includes('VICTORY') ? 'lime' : (result.includes('DEFEAT') ? 'red' : 'white'));

                    console.log(result);
                    
                    // Hide all models after combat
                    document.getElementById('mage-model').setAttribute('visible', false);
                    document.getElementById('warrior-model').setAttribute('visible', false);
                    document.getElementById('archer-model').setAttribute('visible', false);
                    
                    // Reset game state after a delay
                    setTimeout(() => {
                        window.playerChar = null;
                        resultText.setAttribute('value', 'SCAN a marker to SELECT your character.');
                        resultText.setAttribute('color', 'white');

                    }, 5000);
                }
            });

            // --- Marker Lost Event ---
            el.addEventListener('markerLost', () => {
                // If a character is selected, only hide the opponent's model when lost
                if (window.playerChar === null || window.playerChar === charName) {
                     modelEntity.setAttribute('visible', false);
                }
            });
        }
    });
</script>


<a-scene 
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    raycaster="objects: [raycaster-target];"
    cursor="fuse: false; rayOrigin: mouse;"
>

    <a-assets>
        <a-asset-item id="mage-model-asset" src="/mage.glb"></a-asset-item>
        <a-asset-item id="warrior-model-asset" src="/warrior.glb"></a-asset-item>
        <a-asset-item id="archer-model-asset" src="/archer.glb"></a-asset-item>
    </a-assets>

    <a-entity camera>
        <a-text
            id="result-text"
            value="SCAN a marker to SELECT your character."
            color="white"
            align="center"
            width="1"
            position="0 0.5 -30"
        ></a-text>
    </a-entity>
    
    <a-nft
        type="nft"
        url="mage" 
        emitevents="true"
        id="marker-a"
        rpg-marker-listener="char: mage"
    >
        <a-gltf-model
            id="mage-model"
            src="#mage-model-asset"
            scale="75 75 75"        rotation="-90 0 0"
            position="100 0 0.5"          visible="false"            ></a-gltf-model>
    </a-nft>


    <a-nft
        type="nft"
        url="warrior" 
        emitevents="true"
        id="marker-b"
        rpg-marker-listener="char: warrior"
    >
        <a-gltf-model
            id="warrior-model"
            src="#warrior-model-asset"
            scale="50 59 59"
            rotation="-90 0 0"
            position="70 0 10"
            visible="false"
        ></a-gltf-model>
    </a-nft>

=
    <a-nft
        type="nft"
        url="archer" 
        emitevents="true"
        id="marker-c"
        rpg-marker-listener="char: archer"
    >
        <a-gltf-model
            id="archer-model"
            src="#archer-model-asset"
            scale="75 75 75"
            rotation="-90 0 0"
            position="50 0 30"
            visible="false"
        ></a-gltf-model>
    </a-nft>

</a-scene>

</body>
</html>