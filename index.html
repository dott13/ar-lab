<!DOCTYPE html>
<html>
<head>
    <title>Game of Thrones AR: The Vision of Bran</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }
    </style>
</head>

<body>

<script>
    window.visionSeen = false;

    // ----------------------- MODEL LOAD CHECKER -----------------------
    AFRAME.registerComponent('model-checker', {
        schema: { modelName: { type: 'string' } },
        
        init: function () {
            const modelName = this.data.modelName;
            
            this.el.addEventListener('model-loaded', () => {
                console.log(`✓ ${modelName} loaded successfully`);
            });
            
            this.el.addEventListener('model-error', (e) => {
                console.error(`✗ ${modelName} failed to load:`, e);
            });
        }
    });

    // ----------------------- RAVEN LISTENER -----------------------
    AFRAME.registerComponent('raven-listener', {
        init: function () {
            const el = this.el;
            const markerB = document.getElementById('marker-b');
            const visionText = document.getElementById('vision-text');

            markerB.addEventListener('markerFound', () => {
                if (!window.visionSeen) {
                    window.visionSeen = true;

                    visionText.setAttribute(
                        'value',
                        'A Vision:\n"The ink is dry. The past is already written."\n- Bran the Broken'
                    );
                    visionText.setAttribute('visible', true);

                    setTimeout(() => {
                        visionText.setAttribute('visible', false);
                    }, 5000);
                }
            });

            markerB.addEventListener('markerLost', () => {
                visionText.setAttribute('visible', false);
            });

            el.addEventListener('touchend', () => {
                console.log("Raven tapped.");
            });
        }
    });

    // ----------------------- KING'S SEAL LOGIC -----------------------
    AFRAME.registerComponent('kings-seal-logic', {
        init: function () {
            const marker = this.el;
            const scroll = document.getElementById('scroll-entity');

            marker.addEventListener('markerFound', () => {
                if (window.visionSeen) {
                    scroll.setAttribute('visible', true);
                } else {
                    scroll.setAttribute('visible', false);
                }
            });

            marker.addEventListener('markerLost', () => {
                scroll.setAttribute('visible', false);
            });
        }
    });

    // ----------------------- DEBUG COMPONENT -----------------------
    AFRAME.registerComponent('marker-debug', {
        schema: { markerId: { type: 'string' } },

        init: function () {
            this.markerID = this.data.markerId;
            this.statusText = document.getElementById('debug-status');

            const marker = document.getElementById(this.markerID);

            marker.addEventListener('markerFound', () => {
                this.statusText.setAttribute('value', `TRACKING ${this.markerID.toUpperCase()}: SUCCESS!`);
                this.statusText.setAttribute('color', 'green');
                console.log(`${this.markerID} marker found!`);
            });

            marker.addEventListener('markerLost', () => {
                this.statusText.setAttribute('value', `STATUS: Waiting for ${this.markerID.toUpperCase()}...`);
                this.statusText.setAttribute('color', 'red');
                console.log(`${this.markerID} marker lost`);
            });
        }
    });
</script>


<!-- ========================= SCENE ========================= -->

<a-scene 
    embedded
    vr-mode-ui="enabled: false"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    renderer="logarithmicDepthBuffer: true;"
    raycaster="objects: .raycaster-target;" 
    cursor="fuse: false; rayOrigin: mouse;"
>

    <a-assets timeout="60000">
        <a-asset-item id="throne-model" src="iron_throne.glb"></a-asset-item>
        <a-asset-item id="bran-model" src="bran_stark.glb"></a-asset-item>
        <a-asset-item id="raven-model" src="raven.glb"></a-asset-item>
        <a-asset-item id="scroll-model" src="scroll.glb"></a-asset-item>
    </a-assets>

    <!-- DEBUG TEXT -->
    <a-text
        id="debug-status"
        value="STATUS: Loading Camera..."
        color="red"
        position="0 0.4 -1"
        scale="0.25 0.25 0.25"
        align="center"
    ></a-text>


    <!-- ========================= MARKER A (THRONE) ========================= -->
    <a-nft type="nft" url="stark_sigil" emitevents="true" id="marker-a" marker-debug="markerId: marker-a">
        
        <!-- Fallback box to test visibility -->
        <a-box 
            color="red" 
            position="0 0.5 0" 
            scale="0.3 0.3 0.3"
            material="opacity: 0.5; transparent: true"
        ></a-box>
        
        <!-- Throne model -->
        <a-gltf-model
            src="#throne-model"
            scale="1 1 1"
            position="0 0 0"
            rotation="0 0 0"
            model-checker="modelName: Throne"
        ></a-gltf-model>
        
        <!-- Debug text on marker -->
        <a-text
            value="THRONE MARKER"
            color="white"
            position="0 1 0"
            scale="0.5 0.5 0.5"
            align="center"
        ></a-text>
    </a-nft>


    <!-- ========================= MARKER B (BRAN + RAVEN) ========================= -->
    <a-nft type="nft" url="raven_sigil" emitevents="true" id="marker-b">

        <a-entity raven-listener marker-debug="markerId: marker-b">

            <!-- Fallback box -->
            <a-box 
                color="blue" 
                position="0 0.5 0" 
                scale="0.3 0.3 0.3"
                material="opacity: 0.5; transparent: true"
            ></a-box>

            <!-- Bran model -->
            <a-gltf-model
                id="bran-entity"
                src="#bran-model"
                scale="1 1 1"
                position="0 0 0"
                rotation="0 0 0"
                model-checker="modelName: Bran"
            ></a-gltf-model>

            <!-- Raven model -->
            <a-gltf-model
                id="raven-entity"
                src="#raven-model"
                class="raycaster-target"
                scale="0.5 0.5 0.5"
                position="0 1 0"
                rotation="0 0 0"
                visible="true"
                model-checker="modelName: Raven"
            ></a-gltf-model>

            <!-- Vision text -->
            <a-text
                id="vision-text"
                value="Tap the Raven to Receive the Vision..."
                color="#FFD700"
                width="2"
                position="0 1.5 0"
                align="center"
                wrapCount="30"
                rotation="0 0 0"
                visible="true"
            ></a-text>
            
            <!-- Debug text -->
            <a-text
                value="RAVEN MARKER"
                color="white"
                position="0 2 0"
                scale="0.5 0.5 0.5"
                align="center"
            ></a-text>

        </a-entity>

    </a-nft>


    <!-- ========================= MARKER C (SCROLL) ========================= -->
    <a-nft 
        type="nft" 
        url="kings_seal" 
        emitevents="true" 
        id="marker-c" 
        kings-seal-logic 
        marker-debug="markerId: marker-c"
    >
        <!-- Fallback box -->
        <a-box 
            color="green" 
            position="0 0.5 0" 
            scale="0.3 0.3 0.3"
            material="opacity: 0.5; transparent: true"
        ></a-box>
        
        <!-- Scroll model -->
        <a-gltf-model
            id="scroll-entity"
            src="#scroll-model"
            scale="1 1 1"
            position="0 0 0"
            rotation="-15 0 0"
            visible="false"
            model-checker="modelName: Scroll"
        ></a-gltf-model>
        
        <!-- Debug text -->
        <a-text
            value="SEAL MARKER"
            color="white"
            position="0 1 0"
            scale="0.5 0.5 0.5"
            align="center"
        ></a-text>
    </a-nft>

</a-scene>

</body>
</html>